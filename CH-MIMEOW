<!DOCTYPE html>
<html lang="zh-HK">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>CH X å’ªå–µ ç¬¬ä¸€å±†-æˆ‘è¦åšMODEL</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    
    body {
      font-family: 'Microsoft JhengHei', 'PingFang TC', sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
      padding: 20px;
    }
    
    .container {
      max-width: 1200px;
      margin: 0 auto;
    }
    
    .header {
      text-align: center;
      color: white;
      margin-bottom: 30px;
    }
    
    .header h1 {
      font-size: 2.5em;
      margin-bottom: 10px;
      text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
    }
    
    .theme-display {
      background: rgba(255,255,255,0.2);
      padding: 15px;
      border-radius: 10px;
      margin-top: 15px;
    }
    
    .card {
      background: white;
      border-radius: 15px;
      padding: 30px;
      box-shadow: 0 10px 30px rgba(0,0,0,0.3);
      margin-bottom: 20px;
    }
    
    .loading {
      text-align: center;
      padding: 50px;
      color: #667eea;
      font-size: 1.2em;
    }
    
    /* ç™»å…¥é é¢ */
    .login-section {
      max-width: 900px;
      margin: 0 auto;
    }
    
    .login-card {
      max-width: 400px;
      margin: 0 auto;
    }
    
    .login-section input {
      width: 100%;
      padding: 15px;
      font-size: 1.1em;
      border: 2px solid #ddd;
      border-radius: 10px;
      margin-bottom: 15px;
    }
    
    .button-row {
      display: flex;
      gap: 10px;
      margin-top: 15px;
    }
    
    .button-row button {
      flex: 1;
    }
    
    /* æ’è¡Œæ¦œ */
    .leaderboard {
      margin-bottom: 30px;
      display: none;
    }
    
    .leaderboard.active {
      display: block;
      animation: slideDown 0.3s ease-out;
    }
    
    @keyframes slideDown {
      from {
        opacity: 0;
        transform: translateY(-10px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }
    
    .leaderboard-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
    }
    
    .leaderboard-header h2 {
      color: #333;
    }
    
    .update-time {
      font-size: 0.9em;
      color: #666;
    }
    
    .leaderboard-list {
      display: grid;
      gap: 12px;
    }
    
    .leaderboard-item {
      display: flex;
      align-items: center;
      gap: 15px;
      padding: 15px 20px;
      background: #f8f9fa;
      border-radius: 10px;
      transition: all 0.3s;
    }
    
    .leaderboard-item:hover {
      transform: translateX(5px);
      box-shadow: 0 4px 12px rgba(0,0,0,0.1);
    }
    
    .rank {
      font-size: 2em;
      font-weight: bold;
      min-width: 60px;
      text-align: center;
    }
    
    .rank-1 { color: #ffd700; text-shadow: 2px 2px 4px rgba(255,215,0,0.3); }
    .rank-2 { color: #c0c0c0; text-shadow: 2px 2px 4px rgba(192,192,192,0.3); }
    .rank-3 { color: #cd7f32; text-shadow: 2px 2px 4px rgba(205,127,50,0.3); }
    .rank-other { color: #999; }
    
    .leaderboard-image {
      width: 80px;
      height: 80px;
      object-fit: cover;
      border-radius: 8px;
      border: 2px solid #ddd;
    }
    
    .leaderboard-info {
      flex: 1;
    }
    
    .leaderboard-title {
      font-size: 1.2em;
      font-weight: bold;
      color: #333;
    }
    
    .leaderboard-votes {
      font-size: 1.5em;
      font-weight: bold;
      color: #667eea;
      min-width: 100px;
      text-align: right;
    }
    
    .no-data {
      text-align: center;
      color: #999;
      padding: 30px;
      font-style: italic;
    }
    
    .btn {
      padding: 15px 30px;
      font-size: 1.1em;
      border: none;
      border-radius: 10px;
      cursor: pointer;
      transition: all 0.3s;
      font-weight: bold;
    }
    
    .btn-primary {
      background: #667eea;
      color: white;
      width: 100%;
    }
    
    .btn-primary:hover {
      background: #5568d3;
      transform: translateY(-2px);
    }
    
    .btn-secondary {
      background: #6c757d;
      color: white;
    }
    
    .btn-secondary:hover {
      background: #5a6268;
    }
    
    .btn-admin {
      background: #ff6b6b;
      color: white;
    }
    
    .btn-admin:hover {
      background: #ee5a52;
      transform: translateY(-2px);
    }
    
    .btn-leaderboard {
      background: linear-gradient(135deg, #ffd700 0%, #ffed4e 100%);
      color: #333;
      box-shadow: 0 4px 15px rgba(255, 215, 0, 0.3);
    }
    
    .btn-leaderboard:hover {
      background: linear-gradient(135deg, #ffed4e 0%, #ffd700 100%);
      box-shadow: 0 6px 20px rgba(255, 215, 0, 0.4);
      transform: translateY(-2px);
    }
    
    .btn-success {
      background: #28a745;
      color: white;
    }
    
    .btn-success:hover {
      background: #218838;
    }
    
    .btn-warning {
      background: #ffc107;
      color: #333;
    }
    
    .btn-warning:hover {
      background: #e0a800;
    }
    
    /* æŠ•ç¥¨é é¢ */
    .voting-section {
      display: none;
    }
    
    .stats-bar {
      display: flex;
      justify-content: space-around;
      margin-bottom: 20px;
      padding: 15px;
      background: #f8f9fa;
      border-radius: 10px;
    }
    
    .stat-item {
      text-align: center;
    }
    
    .stat-value {
      font-size: 2em;
      font-weight: bold;
      color: #667eea;
    }
    
    .stat-label {
      color: #666;
      margin-top: 5px;
    }
    
    .voting-area {
      display: flex;
      gap: 20px;
      margin-bottom: 20px;
    }
    
    .candidate {
      flex: 1;
      text-align: center;
    }
    
    .image-container {
      width: 100%;
      height: 400px;
      background: #f0f0f0;
      border-radius: 10px;
      margin-bottom: 15px;
      overflow: hidden;
      display: flex;
      align-items: center;
      justify-content: center;
      border: 3px solid #ddd;
    }
    
    .image-container img {
      max-width: 100%;
      max-height: 100%;
      object-fit: cover;
    }
    
    .image-placeholder {
      color: #999;
      font-size: 1.2em;
    }
    
    .vote-btn {
      width: 100%;
      padding: 15px;
      font-size: 1.2em;
      background: #28a745;
      color: white;
      border: none;
      border-radius: 10px;
      cursor: pointer;
      transition: all 0.3s;
      font-weight: bold;
    }
    
    .vote-btn:hover {
      background: #218838;
      transform: scale(1.05);
    }
    
    .vote-btn:disabled {
      background: #ccc;
      cursor: not-allowed;
      transform: none;
    }
    
    .refresh-btn {
      width: 100%;
      padding: 15px;
      margin-top: 15px;
    }
    
    /* å¾Œå°ç®¡ç† */
    .admin-section {
      display: none;
    }
    
    .admin-login-section {
      display: none;
      max-width: 400px;
      margin: 0 auto;
    }
    
    .admin-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
      flex-wrap: wrap;
      gap: 10px;
    }
    
    .admin-actions {
      display: flex;
      gap: 10px;
    }
    
    .form-group {
      margin-bottom: 20px;
    }
    
    .form-group label {
      display: block;
      margin-bottom: 8px;
      font-weight: bold;
      color: #333;
    }
    
    .form-group input[type="text"],
    .form-group input[type="password"],
    .form-group textarea {
      width: 100%;
      padding: 12px;
      border: 2px solid #ddd;
      border-radius: 8px;
      font-size: 1em;
    }
    
    .form-group textarea {
      resize: vertical;
      min-height: 100px;
    }
    
    .checkbox-group {
      display: flex;
      align-items: center;
      gap: 10px;
      padding: 12px;
      background: #f8f9fa;
      border-radius: 8px;
    }
    
    .checkbox-group input[type="checkbox"] {
      width: 20px;
      height: 20px;
      cursor: pointer;
    }
    
    .checkbox-group label {
      margin: 0;
      cursor: pointer;
      font-weight: normal;
    }
    
    .image-upload {
      border: 2px dashed #ddd;
      padding: 30px;
      text-align: center;
      border-radius: 10px;
      cursor: pointer;
      transition: all 0.3s;
    }
    
    .image-upload:hover {
      border-color: #667eea;
      background: #f8f9fa;
    }
    
    .submissions-list {
      margin-top: 30px;
    }
    
    .submission-item {
      display: flex;
      gap: 15px;
      padding: 15px;
      background: #f8f9fa;
      border-radius: 10px;
      margin-bottom: 15px;
      align-items: center;
      flex-wrap: wrap;
    }
    
    .submission-item img {
      width: 100px;
      height: 100px;
      object-fit: cover;
      border-radius: 8px;
    }
    
    .submission-info {
      flex: 1;
      min-width: 200px;
    }
    
    .submission-votes {
      font-size: 1.5em;
      font-weight: bold;
      color: #667eea;
    }
    
    .submission-actions {
      display: flex;
      flex-direction: column;
      gap: 8px;
    }
    
    .delete-btn {
      background: #dc3545;
      color: white;
      padding: 8px 15px;
      border: none;
      border-radius: 5px;
      cursor: pointer;
    }
    
    .delete-btn:hover {
      background: #c82333;
    }
    
    .view-voters-btn {
      background: #17a2b8;
      color: white;
      padding: 8px 15px;
      border: none;
      border-radius: 5px;
      cursor: pointer;
    }
    
    .view-voters-btn:hover {
      background: #138496;
    }
    
    .voters-list {
      width: 100%;
      margin-top: 10px;
      padding: 10px;
      background: white;
      border-radius: 5px;
      border: 1px solid #ddd;
    }
    
    .voters-list h5 {
      margin-bottom: 8px;
      color: #667eea;
    }
    
    .voter-tag {
      display: inline-flex;
      align-items: center;
      gap: 5px;
      background: #667eea;
      color: white;
      padding: 5px 12px;
      border-radius: 15px;
      margin: 3px;
      font-size: 0.9em;
    }
    
    .remove-voter-btn {
      background: #dc3545;
      border: none;
      color: white;
      border-radius: 50%;
      width: 18px;
      height: 18px;
      font-size: 12px;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 0;
      line-height: 1;
    }
    
    .remove-voter-btn:hover {
      background: #c82333;
    }
    
    .no-voters {
      color: #999;
      font-style: italic;
    }
    
    .hidden {
      display: none;
    }
    
    .warning {
      color: #dc3545;
      font-weight: bold;
      margin-top: 10px;
    }
    
    .success-message {
      color: #28a745;
      font-weight: bold;
      margin-top: 10px;
      text-align: center;
      font-size: 1.2em;
    }
    
    @media (max-width: 768px) {
      .voting-area {
        flex-direction: column;
      }
      
      .header h1 {
        font-size: 1.8em;
      }
      
      .submission-item {
        flex-direction: column;
        align-items: flex-start;
      }
      
      .admin-actions {
        width: 100%;
        flex-direction: column;
      }
      
      .admin-actions button {
        width: 100%;
      }
      
      .leaderboard-item {
        flex-wrap: wrap;
      }
      
      .rank {
        font-size: 1.5em;
        min-width: 50px;
      }
      
      .leaderboard-votes {
        font-size: 1.3em;
      }
      
      .button-row {
        flex-direction: column;
      }
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <h1>CH X å’ªå–µ ç¬¬ä¸€å±†-æˆ‘è¦åšMODEL</h1>
      <div class="theme-display" id="themeDisplay">
        <h2 id="currentTheme">æœ¬å­£ä¸»é¡Œï¼šè¼‰å…¥ä¸­...</h2>
      </div>
    </div>
    
    <div class="loading" id="loadingScreen">
      <p>ğŸ”„ è¼‰å…¥ä¸­...</p>
    </div>
    
    <!-- ç™»å…¥é é¢ -->
    <div class="login-section" id="loginSection" style="display: none;">
      <!-- æ’è¡Œæ¦œ -->
      <div class="card leaderboard" id="leaderboardCard">
        <div class="leaderboard-header">
          <h2>ğŸ† ç•¶å‰æ’è¡Œæ¦œ</h2>
          <div class="update-time" id="updateTime">æ›´æ–°æ™‚é–“ï¼šè¼‰å…¥ä¸­...</div>
        </div>
        <div class="leaderboard-list" id="leaderboardList">
          <div class="no-data">æš«ç„¡æ’è¡Œæ•¸æ“š</div>
        </div>
      </div>
      
      <!-- ç™»å…¥å¡ç‰‡ -->
      <div class="card login-card">
        <h2 style="margin-bottom: 20px; text-align: center;">æ­¡è¿åƒèˆ‡æŠ•ç¥¨</h2>
        <input type="text" id="usernameInput" placeholder="è«‹è¼¸å…¥ä½ çš„å§“å" />
        <button class="btn btn-primary" onclick="login()">é–‹å§‹æŠ•ç¥¨</button>
        
        <div class="button-row">
          <button class="btn btn-leaderboard" onclick="toggleLeaderboard()">
            <span id="leaderboardBtnText">æŸ¥çœ‹æ’è¡Œæ¦œ</span>
          </button>
          <button class="btn btn-admin" onclick="showAdminLogin()">å¾Œå°ç®¡ç†</button>
        </div>
      </div>
    </div>
    
    <!-- å¾Œå°ç™»å…¥é é¢ -->
    <div class="admin-login-section" id="adminLoginSection">
      <div class="card">
        <h2 style="margin-bottom: 20px; text-align: center;">ğŸ” å¾Œå°ç™»å…¥</h2>
        <input type="password" id="adminPasswordInput" placeholder="è«‹è¼¸å…¥ç®¡ç†å“¡å¯†ç¢¼" />
        <button class="btn btn-primary" onclick="adminLogin()">ç™»å…¥</button>
        <button class="btn btn-secondary" onclick="backToLoginFromAdmin()" style="margin-top: 10px;">è¿”å›</button>
      </div>
    </div>
    
    <!-- æŠ•ç¥¨é é¢ -->
    <div class="voting-section" id="votingSection">
      <div class="card">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
          <h2>æ­¡è¿ï¼Œ<span id="displayUsername"></span>ï¼</h2>
          <button class="btn btn-secondary" onclick="logout()">ç™»å‡º</button>
        </div>
        
        <div class="stats-bar">
          <div class="stat-item">
            <div class="stat-value" id="votesLeft">5</div>
            <div class="stat-label">å‰©é¤˜ç¥¨æ•¸</div>
          </div>
          <div class="stat-item">
            <div class="stat-value" id="refreshLeft">15</div>
            <div class="stat-label">åˆ·æ–°æ¬¡æ•¸</div>
          </div>
        </div>
        
        <div class="voting-area">
          <div class="candidate">
            <div class="image-container" id="imageLeft">
              <div class="image-placeholder">è¼‰å…¥ä¸­...</div>
            </div>
            <button class="vote-btn" onclick="vote('left')">æŠ•çµ¦é€™å€‹ â†</button>
          </div>
          
          <div class="candidate">
            <div class="image-container" id="imageRight">
              <div class="image-placeholder">è¼‰å…¥ä¸­...</div>
            </div>
            <button class="vote-btn" onclick="vote('right')">æŠ•çµ¦é€™å€‹ â†’</button>
          </div>
        </div>
        
        <button class="btn btn-secondary refresh-btn" onclick="refresh()">
          ğŸ”„ ä¸æ»¿æ„ï¼Ÿåˆ·æ–°é…å° (<span id="refreshCount">15</span> æ¬¡å‰©é¤˜)
        </button>
        
        <div class="success-message" id="successMsg"></div>
        <div class="warning" id="warningMsg"></div>
      </div>
    </div>
    
    <!-- å¾Œå°ç®¡ç† -->
    <div class="admin-section" id="adminSection">
      <div class="card">
        <div class="admin-header">
          <h2>å¾Œå°ç®¡ç†</h2>
          <div class="admin-actions">
            <button class="btn btn-warning" onclick="manualUpdateLeaderboard()">ğŸ”„ æ›´æ–°æ’è¡Œæ¦œ</button>
            <button class="btn btn-secondary" onclick="backToLogin()">ç™»å‡º</button>
          </div>
        </div>
        
        <div class="form-group">
          <label>æœ¬å­£ä¸»é¡Œ</label>
          <input type="text" id="themeInput" placeholder="ä¾‹å¦‚ï¼šå¤æ—¥æµ·ç˜é¢¨" />
          <button class="btn btn-primary" onclick="setTheme()" style="margin-top: 10px;">è¨­å®šä¸»é¡Œ</button>
        </div>
        
        <div class="form-group">
          <label>é¡¯ç¤ºè¨­å®š</label>
          <div class="checkbox-group">
            <input type="checkbox" id="showImagesCheckbox" onchange="toggleImageDisplay()" checked />
            <label for="showImagesCheckbox">åœ¨æ’è¡Œæ¦œé¡¯ç¤ºåœ–ç‰‡</label>
          </div>
        </div>
        
        <div class="form-group">
          <label>ä¸Šå‚³åƒè³½ä½œå“</label>
          <input type="text" id="submissionTitle" placeholder="ä½œå“æ¨™é¡Œ" style="margin-bottom: 10px;" />
          <div class="image-upload" onclick="document.getElementById('fileInput').click()">
            <p>ğŸ“· é»æ“Šä¸Šå‚³åœ–ç‰‡</p>
            <p style="color: #999; font-size: 0.9em;">æˆ–æ‹–æ›³åœ–ç‰‡åˆ°æ­¤è™•</p>
            <input type="file" id="fileInput" accept="image/*" style="display: none;" onchange="uploadImage()" />
          </div>
        </div>
        
        <div class="submissions-list">
          <h3 style="margin-bottom: 15px;">æ‰€æœ‰åƒè³½ä½œå“</h3>
          <div id="submissionsList"></div>
        </div>
      </div>
    </div>
  </div>
  
  <!-- Firebase SDK -->
  <script type="module">
    import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
    import { getFirestore, collection, doc, getDoc, getDocs, setDoc, updateDoc, deleteDoc, query, orderBy, limit, onSnapshot, increment, arrayUnion, arrayRemove } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js';
    
    // âš ï¸ è«‹æ›¿æ›æˆä½ çš„ Firebase è¨­å®š
    const firebaseConfig = {
    apiKey: "AIzaSyBVLLiHWQQ7Sr-d_Rwdavwjojp2IXH_Gug",
    authDomain: "ch-mimeow.firebaseapp.com",
    projectId: "ch-mimeow",
    storageBucket: "ch-mimeow.firebasestorage.app",
    messagingSenderId: "633558087640",
    appId: "1:633558087640:web:b4aca508115aff9ad224ad"
    };

    
    // åˆå§‹åŒ– Firebase
    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    
    // å…¨åŸŸè®Šæ•¸
    let currentUser = null;
    let isAdminLoggedIn = false;
    let isLeaderboardOpen = false;
    let appSettings = null;
    let allSubmissions = [];
    let currentPair = null;
    
    // åˆå§‹åŒ–
    async function init() {
      try {
        await loadSettings();
        await loadSubmissions();
        setupRealtimeListeners();
        hideLoading();
      } catch (error) {
        console.error('åˆå§‹åŒ–éŒ¯èª¤:', error);
        alert('è¼‰å…¥å¤±æ•—ï¼Œè«‹é‡æ–°æ•´ç†é é¢');
      }
    }
    
    // éš±è—è¼‰å…¥ç•«é¢
    function hideLoading() {
      document.getElementById('loadingScreen').style.display = 'none';
      document.getElementById('loginSection').style.display = 'block';
    }
    
    // è¼‰å…¥è¨­å®š
    async function loadSettings() {
      const settingsDoc = await getDoc(doc(db, 'settings', 'app'));
      if (settingsDoc.exists()) {
        appSettings = settingsDoc.data();
      } else {
        // åˆå§‹åŒ–é è¨­è¨­å®š
        appSettings = {
          theme: 'è–èª•ç¯€å¿«æ¨‚',
          adminPassword: 'admin00852',
          showLeaderboardImages: false
        };
        await setDoc(doc(db, 'settings', 'app'), appSettings);
      }
      updateThemeDisplay();
    }
    
    // è¼‰å…¥æ‰€æœ‰ä½œå“
    async function loadSubmissions() {
      const submissionsSnapshot = await getDocs(collection(db, 'submissions'));
      allSubmissions = [];
      submissionsSnapshot.forEach((doc) => {
        allSubmissions.push({ id: doc.id, ...doc.data() });
      });
    }
    
    // è¨­å®šå³æ™‚ç›£è½
    function setupRealtimeListeners() {
      // ç›£è½ä½œå“è®ŠåŒ–
      onSnapshot(collection(db, 'submissions'), (snapshot) => {
        allSubmissions = [];
        snapshot.forEach((doc) => {
          allSubmissions.push({ id: doc.id, ...doc.data() });
        });
        if (isAdminLoggedIn) {
          displaySubmissions();
        }
        displayLeaderboard();
      });
      
      // ç›£è½è¨­å®šè®ŠåŒ–
      onSnapshot(doc(db, 'settings', 'app'), (doc) => {
        if (doc.exists()) {
          appSettings = doc.data();
          updateThemeDisplay();
          displayLeaderboard();
        }
      });
      
      // ç›£è½æ’è¡Œæ¦œè®ŠåŒ–
      onSnapshot(doc(db, 'settings', 'leaderboard'), (doc) => {
        displayLeaderboard();
      });
    }
    
    // æ›´æ–°ä¸»é¡Œé¡¯ç¤º
    function updateThemeDisplay() {
      document.getElementById('currentTheme').textContent = `æœ¬å­£ä¸»é¡Œï¼š${appSettings.theme}`;
    }
    
    // åˆ‡æ›æ’è¡Œæ¦œé¡¯ç¤º
    window.toggleLeaderboard = function() {
      const card = document.getElementById('leaderboardCard');
      const btnText = document.getElementById('leaderboardBtnText');
      
      isLeaderboardOpen = !isLeaderboardOpen;
      
      if (isLeaderboardOpen) {
        card.classList.add('active');
        btnText.textContent = 'æ”¶èµ·æ’è¡Œæ¦œ';
        card.scrollIntoView({ behavior: 'smooth', block: 'start' });
      } else {
        card.classList.remove('active');
        btnText.textContent = 'æŸ¥çœ‹æ’è¡Œæ¦œ';
      }
    };
    
    // é¡¯ç¤ºæ’è¡Œæ¦œ
    async function displayLeaderboard() {
      const list = document.getElementById('leaderboardList');
      const updateTimeEl = document.getElementById('updateTime');
      
      const leaderboardDoc = await getDoc(doc(db, 'settings', 'leaderboard'));
      
      if (!leaderboardDoc.exists() || !leaderboardDoc.data().data) {
        list.innerHTML = '<div class="no-data">æš«ç„¡æ’è¡Œæ•¸æ“š</div>';
        updateTimeEl.textContent = 'æ›´æ–°æ™‚é–“ï¼šå°šæœªæ›´æ–°';
        return;
      }
      
      const leaderboardData = leaderboardDoc.data();
      const updateDate = new Date(leaderboardData.lastUpdate);
      updateTimeEl.textContent = `æ›´æ–°æ™‚é–“ï¼š${updateDate.toLocaleString('zh-HK')}`;
      
      if (leaderboardData.data.length === 0) {
        list.innerHTML = '<div class="no-data">æš«ç„¡æ’è¡Œæ•¸æ“š</div>';
        return;
      }
      
      list.innerHTML = leaderboardData.data.map((item, index) => {
        const rank = index + 1;
        let rankClass = 'rank-other';
        let rankIcon = `${rank}`;
        
        if (rank === 1) {
          rankClass = 'rank-1';
          rankIcon = 'ğŸ¥‡';
        } else if (rank === 2) {
          rankClass = 'rank-2';
          rankIcon = 'ğŸ¥ˆ';
        } else if (rank === 3) {
          rankClass = 'rank-3';
          rankIcon = 'ğŸ¥‰';
        }
        
        const imageHtml = appSettings.showLeaderboardImages 
          ? `<img src="${item.image}" alt="${item.title}" class="leaderboard-image" />`
          : '';
        
        return `
          <div class="leaderboard-item">
            <div class="rank ${rankClass}">${rankIcon}</div>
            ${imageHtml}
            <div class="leaderboard-info">
              <div class="leaderboard-title">${item.title}</div>
            </div>
            <div class="leaderboard-votes">${item.votes} ç¥¨</div>
          </div>
        `;
      }).join('');
    }
    
    // ç™»å…¥
    window.login = async function() {
      const username = document.getElementById('usernameInput').value.trim();
      if (!username) {
        alert('è«‹è¼¸å…¥å§“åï¼');
        return;
      }
      
      currentUser = username;
      
      // æª¢æŸ¥æˆ–å‰µå»ºç”¨æˆ¶è³‡æ–™
      const userDoc = await getDoc(doc(db, 'users', username));
      const today = new Date().toDateString();
      
      if (!userDoc.exists()) {
        await setDoc(doc(db, 'users', username), {
          votesLeft: 5,
          refreshLeft: 15,
          lastVoteDate: today
        });
      } else {
        const userData = userDoc.data();
        if (userData.lastVoteDate !== today) {
          await updateDoc(doc(db, 'users', username), {
            votesLeft: 5,
            refreshLeft: 15,
            lastVoteDate: today
          });
        }
      }
      
      showVotingSection();
    };
    
    // é¡¯ç¤ºæŠ•ç¥¨é é¢
    async function showVotingSection() {
      document.getElementById('loginSection').style.display = 'none';
      document.getElementById('votingSection').style.display = 'block';
      document.getElementById('displayUsername').textContent = currentUser;
      await updateStats();
      loadRandomPair();
    }
    
    // æ›´æ–°çµ±è¨ˆ
    async function updateStats() {
      const userDoc = await getDoc(doc(db, 'users', currentUser));
      const userData = userDoc.data();
      document.getElementById('votesLeft').textContent = userData.votesLeft;
      document.getElementById('refreshLeft').textContent = userData.refreshLeft;
      document.getElementById('refreshCount').textContent = userData.refreshLeft;
    }
    
    // è¼‰å…¥éš¨æ©Ÿé…å°
    function loadRandomPair() {
      document.getElementById('successMsg').textContent = '';
      document.getElementById('warningMsg').textContent = '';
      
      if (allSubmissions.length < 2) {
        document.getElementById('warningMsg').textContent = 'âš ï¸ åƒè³½ä½œå“ä¸è¶³ï¼Œè«‹ç­‰å¾…æ›´å¤šä½œå“ä¸Šå‚³ï¼';
        return;
      }
      
      const indices = [];
      while (indices.length < 2) {
        const idx = Math.floor(Math.random() * allSubmissions.length);
        if (!indices.includes(idx)) {
          indices.push(idx);
        }
      }
      
      currentPair = {
        left: allSubmissions[indices[0]],
        right: allSubmissions[indices[1]]
      };
      
      document.getElementById('imageLeft').innerHTML = `
        <img src="${currentPair.left.image}" alt="${currentPair.left.title}" />
      `;
      document.getElementById('imageRight').innerHTML = `
        <img src="${currentPair.right.image}" alt="${currentPair.right.title}" />
      `;
    }
    
    // æŠ•ç¥¨
    window.vote = async function(side) {
      const userDoc = await getDoc(doc(db, 'users', currentUser));
      const userData = userDoc.data();
      
      if (userData.votesLeft <= 0) {
        alert('ä»Šå¤©çš„æŠ•ç¥¨æ¬¡æ•¸å·²ç”¨å®Œï¼æ˜å¤©å†ä¾†å§ï½');
        return;
      }
      
      if (!currentPair) {
        alert('è«‹å…ˆè¼‰å…¥é…å°ï¼');
        return;
      }
      
      const submission = side === 'left' ? currentPair.left : currentPair.right;
      
      // æ›´æ–°ä½œå“ç¥¨æ•¸å’ŒæŠ•ç¥¨è€…
      await updateDoc(doc(db, 'submissions', submission.id), {
        votes: increment(1),
        voters: arrayUnion(currentUser)
      });
      
      // æ¸›å°‘ç”¨æˆ¶ç¥¨æ•¸
      await updateDoc(doc(db, 'users', currentUser), {
        votesLeft: increment(-1)
      });
      
      await updateStats();
      
      const successMsg = document.getElementById('successMsg');
      successMsg.textContent = 'âœ¨ æŠ•ç¥¨æˆåŠŸï¼';
      
      setTimeout(async () => {
        successMsg.textContent = '';
        const updatedUserDoc = await getDoc(doc(db, 'users', currentUser));
        if (updatedUserDoc.data().votesLeft > 0) {
          loadRandomPair();
        } else {
          document.getElementById('warningMsg').textContent = 'ğŸ‰ ä»Šå¤©çš„æŠ•ç¥¨æ¬¡æ•¸å·²ç”¨å®Œï¼æ˜å¤©å†ä¾†å§ï½';
        }
      }, 1000);
    };
    
    // åˆ·æ–°
    window.refresh = async function() {
      const userDoc = await getDoc(doc(db, 'users', currentUser));
      const userData = userDoc.data();
      
      if (userData.refreshLeft <= 0) {
        alert('åˆ·æ–°æ¬¡æ•¸å·²ç”¨å®Œï¼');
        return;
      }
      
      await updateDoc(doc(db, 'users', currentUser), {
        refreshLeft: increment(-1)
      });
      
      await updateStats();
      loadRandomPair();
    };
    
    // ç™»å‡º
    window.logout = function() {
      currentUser = null;
      document.getElementById('votingSection').style.display = 'none';
      document.getElementById('loginSection').style.display = 'block';
      document.getElementById('usernameInput').value = '';
    };
    
    // é¡¯ç¤ºå¾Œå°ç™»å…¥
    window.showAdminLogin = function() {
      document.getElementById('loginSection').style.display = 'none';
      document.getElementById('adminLoginSection').style.display = 'block';
      document.getElementById('adminPasswordInput').value = '';
    };
    
    // å¾Œå°ç™»å…¥
    window.adminLogin = function() {
      const password = document.getElementById('adminPasswordInput').value;
      if (password === appSettings.adminPassword) {
        isAdminLoggedIn = true;
        showAdmin();
      } else {
        alert('âŒ å¯†ç¢¼éŒ¯èª¤ï¼');
      }
    };
    
    // å¾å¾Œå°ç™»å…¥è¿”å›
    window.backToLoginFromAdmin = function() {
      document.getElementById('adminLoginSection').style.display = 'none';
      document.getElementById('loginSection').style.display = 'block';
    };
    
    // é¡¯ç¤ºå¾Œå°
    function showAdmin() {
      document.getElementById('adminLoginSection').style.display = 'none';
      document.getElementById('adminSection').style.display = 'block';
      document.getElementById('themeInput').value = appSettings.theme;
      document.getElementById('showImagesCheckbox').checked = appSettings.showLeaderboardImages;
      displaySubmissions();
    }
    
    // è¿”å›ç™»å…¥
    window.backToLogin = function() {
      isAdminLoggedIn = false;
      document.getElementById('adminSection').style.display = 'none';
      document.getElementById('loginSection').style.display = 'block';
    };
    
    // è¨­å®šä¸»é¡Œ
    window.setTheme = async function() {
      const theme = document.getElementById('themeInput').value.trim();
      if (!theme) {
        alert('è«‹è¼¸å…¥ä¸»é¡Œï¼');
        return;
      }
      
      await updateDoc(doc(db, 'settings', 'app'), {
        theme: theme
      });
      
      alert('ä¸»é¡Œè¨­å®šæˆåŠŸï¼');
    };
    
    // åˆ‡æ›åœ–ç‰‡é¡¯ç¤º
    window.toggleImageDisplay = async function() {
      const showImages = document.getElementById('showImagesCheckbox').checked;
      
      await updateDoc(doc(db, 'settings', 'app'), {
        showLeaderboardImages: showImages
      });
      
      alert(showImages ? 'âœ… æ’è¡Œæ¦œå·²é–‹å•Ÿåœ–ç‰‡é¡¯ç¤º' : 'âŒ æ’è¡Œæ¦œå·²é—œé–‰åœ–ç‰‡é¡¯ç¤º');
    };
    
    // ä¸Šå‚³åœ–ç‰‡
    window.uploadImage = function() {
      const file = document.getElementById('fileInput').files[0];
      const title = document.getElementById('submissionTitle').value.trim();
      
      if (!file) {
        alert('è«‹é¸æ“‡åœ–ç‰‡ï¼');
        return;
      }
      
      if (!title) {
        alert('è«‹è¼¸å…¥ä½œå“æ¨™é¡Œï¼');
        return;
      }
      
      const reader = new FileReader();
      reader.onload = async function(e) {
        const newSubmission = {
          title: title,
          image: e.target.result,
          votes: 0,
          voters: [],
          uploadDate: new Date().toISOString()
        };
        
        await setDoc(doc(db, 'submissions', Date.now().toString()), newSubmission);
        
        alert('ä½œå“ä¸Šå‚³æˆåŠŸï¼');
        document.getElementById('submissionTitle').value = '';
        document.getElementById('fileInput').value = '';
      };
      
      reader.readAsDataURL(file);
    };
    
    // æ‰‹å‹•æ›´æ–°æ’è¡Œæ¦œ
    window.manualUpdateLeaderboard = async function() {
      if (!confirm('ç¢ºå®šè¦ç«‹å³æ›´æ–°æ’è¡Œæ¦œå—ï¼Ÿé€™æœƒå°‡ç•¶å‰ç¥¨æ•¸å¿«ç…§åˆ°æ’è¡Œæ¦œã€‚')) {
        return;
      }
      
      const sortedSubmissions = [...allSubmissions]
        .sort((a, b) => b.votes - a.votes)
        .slice(0, 10);
      
      const leaderboardData = sortedSubmissions.map(sub => ({
        id: sub.id,
        title: sub.title,
        image: sub.image,
        votes: sub.votes
      }));
      
      await setDoc(doc(db, 'settings', 'leaderboard'), {
        data: leaderboardData,
        lastUpdate: new Date().toISOString()
      });
      
      alert('âœ… æ’è¡Œæ¦œå·²æ›´æ–°ï¼');
    };
    
    // é¡¯ç¤ºæ‰€æœ‰ä½œå“
    function displaySubmissions() {
      const list = document.getElementById('submissionsList');
      
      if (allSubmissions.length === 0) {
        list.innerHTML = '<p style="color: #999; text-align: center;">æš«ç„¡ä½œå“</p>';
        return;
      }
      
      list.innerHTML = allSubmissions.map((sub) => {
        const voters = sub.voters || [];
        const votersHtml = voters.length > 0 
          ? voters.map(voter => `
              <span class="voter-tag">
                ${voter}
                <button class="remove-voter-btn" onclick="removeVoter('${sub.id}', '${voter}')" title="ç§»é™¤æ­¤ç¥¨">Ã—</button>
              </span>
            `).join('')
          : '<span class="no-voters">æš«ç„¡æŠ•ç¥¨è€…</span>';
        
        return `
          <div class="submission-item">
            <img src="${sub.image}" alt="${sub.title}" />
            <div class="submission-info">
              <h4>${sub.title}</h4>
              <p style="color: #666; font-size: 0.9em;">ä¸Šå‚³æ™‚é–“ï¼š${new Date(sub.uploadDate).toLocaleString('zh-HK')}</p>
            </div>
            <div class="submission-votes">${sub.votes} ç¥¨</div>
            <div class="submission-actions">
              <button class="view-voters-btn" onclick="toggleVoters('${sub.id}')">
                ğŸ‘¥ æŸ¥çœ‹æŠ•ç¥¨è€… (${voters.length})
              </button>
              <button class="delete-btn" onclick="deleteSubmission('${sub.id}')">åˆªé™¤ä½œå“</button>
            </div>
            <div class="voters-list" id="voters-${sub.id}" style="display: none;">
              <h5>æŠ•ç¥¨è€…åå–®ï¼ˆé»æ“Š Ã— ç§»é™¤ï¼‰ï¼š</h5>
              ${votersHtml}
            </div>
          </div>
        `;
      }).join('');
    }
    
    // åˆ‡æ›æŠ•ç¥¨è€…é¡¯ç¤º
    window.toggleVoters = function(submissionId) {
      const votersDiv = document.getElementById(`voters-${submissionId}`);
      if (votersDiv.style.display === 'none' || !votersDiv.style.display) {
        votersDiv.style.display = 'block';
      } else {
        votersDiv.style.display = 'none';
      }
    };
    
    // ç§»é™¤æŠ•ç¥¨è€…
    window.removeVoter = async function(submissionId, voterName) {
      if (!confirm(`ç¢ºå®šè¦ç§»é™¤ "${voterName}" çš„æŠ•ç¥¨å—ï¼Ÿ`)) {
        return;
      }
      
      await updateDoc(doc(db, 'submissions', submissionId), {
        voters: arrayRemove(voterName),
        votes: increment(-1)
      });
    };
    
    // åˆªé™¤ä½œå“
    window.deleteSubmission = async function(submissionId) {
      if (!confirm('ç¢ºå®šè¦åˆªé™¤é€™å€‹ä½œå“å—ï¼Ÿ')) {
        return;
      }
      
      await deleteDoc(doc(db, 'submissions', submissionId));
    };
    
    // å•Ÿå‹•æ‡‰ç”¨
    init();
  </script>
</body>
</html>
